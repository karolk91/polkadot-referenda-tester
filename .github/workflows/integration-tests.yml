name: Integration Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  POLKADOT_SDK_VERSION: polkadot-stable2512
  BIN_DIR: ${{ github.workspace }}/.polkadot-bin

jobs:
  # --- Fast validation (no network, no binaries) ---
  validation:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: build
    name: validation

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.2.2

      - name: Download dist
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: dist
          path: dist/

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 22
          cache: yarn

      - name: Install JS dependencies
        run: yarn install --immutable

      - name: Download test binary
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: test-binary
          path: integration-tests/

      - name: Run validation tests
        run: |
          chmod +x integration-tests/test-binary
          integration-tests/test-binary validation_test_suite --nocapture
        env:
          TOOL_PROJECT_DIR: ${{ github.workspace }}
          RUST_LOG: info

  # --- Generate chain specs (runs once, cached for all matrix jobs) ---
  generate-specs:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: build
    name: generate-specs

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.2.2

      - name: Restore chain specs cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.2.2
        id: chainspec-cache
        with:
          path: chain-specs
          key: chainspecs-${{ hashFiles('runtimes/fast/*.wasm', 'integration-tests/tests/generate_chain_specs.rs', 'integration-tests/tests/common/config.rs') }}

      # Everything below is skipped on cache hit
      - name: Free disk space
        if: steps.chainspec-cache.outputs.cache-hit != 'true' && runner.environment == 'github-hosted'
        uses: jlumbroso/free-disk-space@54081f138730dfa15788a46383842cd2f914a1be
        with:
          tool-cache: false

      - name: Cache Polkadot SDK binaries
        if: steps.chainspec-cache.outputs.cache-hit != 'true'
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.2.2
        id: bin-cache
        with:
          path: ${{ env.BIN_DIR }}
          key: polkadot-bin-${{ env.POLKADOT_SDK_VERSION }}-linux-x86_64

      - name: Download Polkadot SDK binaries
        if: steps.chainspec-cache.outputs.cache-hit != 'true' && steps.bin-cache.outputs.cache-hit != 'true'
        run: ./scripts/download-binaries.sh

      - name: Verify binaries
        if: steps.chainspec-cache.outputs.cache-hit != 'true'
        run: |
          chmod +x "${BIN_DIR}"/*
          "${BIN_DIR}/polkadot" --version
          "${BIN_DIR}/polkadot-parachain" --version

      - name: Download generate-specs binary
        if: steps.chainspec-cache.outputs.cache-hit != 'true'
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: generate-specs-binary
          path: integration-tests/

      - name: Generate raw chain specs via zombienet
        if: steps.chainspec-cache.outputs.cache-hit != 'true'
        run: |
          # Background monitor: log system state every 30s
          (
            while true; do
              echo "=== MONITOR $(date -u +%H:%M:%S) ==="
              echo "-- Memory --"
              free -h
              echo "-- Disk --"
              df -h / | tail -1
              echo "-- polkadot processes --"
              ps aux | grep -E 'polkadot|build-spec' | grep -v grep || echo "(none)"
              echo "-- zombienet temp files --"
              find /tmp/zombie-* -name '*.json' -printf '%s %p\n' 2>/dev/null | sort -rn | head -5 || echo "(none)"
              echo "-- chain-specs dir --"
              ls -lh chain-specs/ 2>/dev/null || echo "(empty)"
              echo "-- dmesg OOM (last 5) --"
              dmesg -T 2>/dev/null | grep -i 'oom\|killed' | tail -5 || echo "(no oom)"
              echo ""
              sleep 30
            done
          ) &
          MONITOR_PID=$!

          chmod +x integration-tests/generate_chain_specs-binary
          integration-tests/generate_chain_specs-binary generate_chain_specs --nocapture
          EXIT_CODE=$?

          kill $MONITOR_PID 2>/dev/null || true
          exit $EXIT_CODE
        env:
          CHAIN_SPECS_DIR: ${{ github.workspace }}/chain-specs
          POLKADOT_BINARY_PATH: ${{ env.BIN_DIR }}/polkadot
          POLKADOT_PARACHAIN_BINARY_PATH: ${{ env.BIN_DIR }}/polkadot-parachain
          RUST_LOG: info

      - name: Verify chain specs
        run: ls -lh chain-specs/

  # --- Build: compile Rust test binary + TS CLI (runs once, shared via artifact) ---
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    name: build

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.2.2

      - name: Free disk space
        if: runner.environment == 'github-hosted'
        uses: jlumbroso/free-disk-space@54081f138730dfa15788a46383842cd2f914a1be
        with:
          tool-cache: false

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 22
          cache: yarn

      - name: Install JS dependencies
        run: yarn install --immutable

      - name: Build TypeScript CLI
        run: yarn build

      - name: Upload dist
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: dist
          path: dist/
          retention-days: 1

      - name: Install protoc
        run: sudo apt-get install -y protobuf-compiler

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7 # stable

      - name: Rust cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
        with:
          workspaces: integration-tests
          shared-key: integration-tests
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Compile integration test binaries
        run: |
          cd integration-tests
          # Compile both test targets in one cargo invocation
          cargo test --no-run --test tests --test generate_chain_specs --message-format=json 2>build.log | \
            jq -r 'select(.reason == "compiler-artifact" and .executable != null) | "\(.target.name) \(.executable)"' > binaries.txt
          cat build.log

          # Extract binary paths
          TESTS_BIN=$(grep "^tests " binaries.txt | tail -1 | cut -d' ' -f2)
          GENSPECS_BIN=$(grep "^generate_chain_specs " binaries.txt | tail -1 | cut -d' ' -f2)

          for name in tests generate_chain_specs; do
            BIN=$(grep "^${name} " binaries.txt | tail -1 | cut -d' ' -f2)
            if [ -z "${BIN}" ] || [ ! -f "${BIN}" ]; then
              echo "ERROR: Failed to find ${name} binary"
              exit 1
            fi
            echo "${name}: ${BIN}"
            ls -lh "${BIN}"
            cp "${BIN}" "${name}-binary"
          done

      - name: Upload test binary
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: test-binary
          path: integration-tests/tests-binary
          retention-days: 1
          compression-level: 6

      - name: Upload generate-specs binary
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: generate-specs-binary
          path: integration-tests/generate_chain_specs-binary
          retention-days: 1
          compression-level: 6

  # --- Network integration tests (parallel matrix, after specs + build are ready) ---
  integration-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    needs: [generate-specs, build]

    strategy:
      fail-fast: false
      matrix:
        suite:
          - name: polkadot-governance
            filter: polkadot_governance_all_tracks
          - name: polkadot-fellowship-part1
            filter: polkadot_fellowship_tracks_part1
          - name: polkadot-fellowship-part2
            filter: polkadot_fellowship_tracks_part2
          - name: kusama-governance
            filter: kusama_governance_all_tracks
          - name: kusama-fellowship
            filter: kusama_fellowship_all_tracks

    name: ${{ matrix.suite.name }}

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.2.2

      - name: Free disk space
        if: runner.environment == 'github-hosted'
        uses: jlumbroso/free-disk-space@54081f138730dfa15788a46383842cd2f914a1be
        with:
          tool-cache: false

      # --- Restore cached chain specs (generated by generate-specs job) ---
      - name: Restore chain specs cache
        uses: actions/cache/restore@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.2.2
        with:
          path: chain-specs
          key: chainspecs-${{ hashFiles('runtimes/fast/*.wasm', 'integration-tests/tests/generate_chain_specs.rs', 'integration-tests/tests/common/config.rs') }}
          fail-on-cache-miss: true

      # --- Cache and download Polkadot SDK binaries ---
      - name: Cache Polkadot SDK binaries
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.2.2
        id: bin-cache
        with:
          path: ${{ env.BIN_DIR }}
          key: polkadot-bin-${{ env.POLKADOT_SDK_VERSION }}-linux-x86_64

      - name: Download Polkadot SDK binaries
        if: steps.bin-cache.outputs.cache-hit != 'true'
        run: ./scripts/download-binaries.sh

      - name: Verify and add binaries to PATH
        run: |
          chmod +x "${BIN_DIR}"/*
          echo "${BIN_DIR}" >> "$GITHUB_PATH"
          "${BIN_DIR}/polkadot" --version
          "${BIN_DIR}/polkadot-parachain" --version

      # --- Download pre-built artifacts ---
      - name: Download dist
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: dist
          path: dist/

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 22
          cache: yarn

      - name: Install JS dependencies
        run: yarn install --immutable

      - name: Download test binary
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: test-binary
          path: integration-tests/

      # --- Run tests (using pre-compiled binary, no Rust needed) ---
      - name: Run ${{ matrix.suite.name }} tests
        run: |
          chmod +x integration-tests/test-binary
          integration-tests/test-binary "${TEST_FILTER}" --nocapture
        env:
          TEST_FILTER: ${{ matrix.suite.filter }}
          POLKADOT_BINARY_PATH: ${{ env.BIN_DIR }}/polkadot
          POLKADOT_PARACHAIN_BINARY_PATH: ${{ env.BIN_DIR }}/polkadot-parachain
          TOOL_PROJECT_DIR: ${{ github.workspace }}
          CHAIN_SPECS_DIR: ${{ github.workspace }}/chain-specs
          RUST_LOG: info

      # --- Collect logs on failure ---
      - name: Upload zombienet logs on failure
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: zombienet-logs-${{ matrix.suite.name }}-${{ github.run_id }}
          path: /tmp/zombie-*/**/*.log
          retention-days: 7
